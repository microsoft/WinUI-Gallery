# Sync branches in a mirror repository to a base repo by running this pipeline
# from the mirror repo, and supplying the base repo as a parameter
name: $(BuildDefinitionName)_$(date:yyMMdd)$(rev:.r)

parameters:
  - name: "SourceToTargetBranches"
    type: object
    default:
      main: main
  - name: "SourceRepository"
    type: string
    default: "https://github.com/microsoft/WinUI-Gallery.git"

variables:
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)] # needed for onebranch.pipeline.version task https://aka.ms/obpipelines/versioning
  ENABLE_PRS_DELAYSIGN: 1
  ROOT: $(Build.SourcesDirectory)
  REPOROOT: $(Build.SourcesDirectory)
  OUTPUTROOT: $(REPOROOT)\out
  NUGET_XMLDOC_MODE: none

  # Docker image which is used to build the project https://aka.ms/obpipelines/containers
  WindowsContainerImage: 'onebranch.azurecr.io/windows/ltsc2019/vse2022:latest' 

  Codeql.Enabled: true #  CodeQL once every 3 days on the default branch for all languages its applicable to in that pipeline.

resources:
  repositories: 
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/Microsoft.NonOfficial.yml@templates # https://aka.ms/obpipelines/templates
  parameters:
    platform:
      name: 'windows_undocked' # windows undocked
    
    globalSdl: # Refer the wiki for more options in this parameter: https://aka.ms/obpipelines/sdl
      perStage:
          sdl_sources:
            checkout_all_repos: true
      tsa:
        enabled: false # onebranch publish all sdl results to TSA. If TSA is disabled all SDL tools will forced into 'break' build mode.
      # suppression:
      #   suppressionFile: $(Build.SourcesDirectory)\.gdn\global.gdnsuppress
    
    stages:
    - stage: stage
      jobs:
        - job: SyncMirror
          pool:
            type: windows
          strategy:
            matrix:
              ${{ each branches in parameters.SourceToTargetBranches }}:
                ${{ branches.key }}:
                  SourceBranch: ${{ branches.key }}
                  TargetBranch: ${{ branches.value }}
          
          variables:
            # binaries scanning tools are run on this directory ( https://onebranch.visualstudio.com/OneBranch/_wiki/wikis/OneBranch.wiki/4634/SDL-(Static-Analysis)-for-Containerized-Workflows ) and 
            # this directory is uploaded to pipeline artifacts. More info at https://aka.ms/obpipelines/artifacts
            ob_outputDirectory: $(build.artifactStagingDirectory)
            ob_artifactSuffix: _$(buildPlatform)_$(buildConfiguration)

          dependsOn: []
          steps:
            - checkout: self
              path: s/
              persistCredentials: true

            - task: PowerShell@2
              inputs:
                targetType: 'inline'
                script: |
                  Write-Host "SourceBranch " + "$(SourceBranch)"
                  Write-Host "TargetBranch " + "$(TargetBranch)"

                  $repo = "${{ parameters.SourceRepository }}"
                  git remote add sourcerepo $repo
                  git remote

                  $target = "$(TargetBranch)"
                  git fetch origin $target
                  git checkout $target
                  git pull origin $target

                  $source = "$(SourceBranch)"

                  git config --global user.email "ControlsGallery@microsoft.com"
                  git config --global user.name "Controls Gallery"

                  git fetch sourcerepo $source
                  git pull sourcerepo $source

            - task: CmdLine@2
              inputs:
                script: |
                  git config lfs.https://microsoft.visualstudio.com/WinUI/_git/WinUI-Gallery-Mirror.git/info/lfs.locksverify true
                  git push